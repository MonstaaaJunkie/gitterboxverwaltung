function authHeader(){ const t=localStorage.getItem('jwt'); return {'Authorization':'Bearer '+t,'Content-Type':'application/json'}; }
function requireAdmin(){ const u=JSON.parse(localStorage.getItem('user')||"null"); if(!u || u.role!=='admin') location.replace('/index.html'); }
async function loadUsers(){ const r=await fetch('/api/users',{headers:authHeader()}); if(!r.ok){ if(r.status===401) location.replace('/login.html'); else alert('Fehler beim Laden'); return;} const list=await r.json(); const tbody=document.getElementById('users-body'); tbody.innerHTML=list.map(u=>`<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td><td><button class="btn btn-danger" data-id="${u.id}">Löschen</button></td></tr>`).join(''); }
async function addUser(e){ e.preventDefault(); const username=document.getElementById('u-username').value.trim(); const password=document.getElementById('u-password').value.trim(); const role=document.getElementById('u-role').value; const r=await fetch('/api/users',{method:'POST',headers:authHeader(),body:JSON.stringify({username,password,role})}); const d=await r.json().catch(()=>({})); if(!r.ok){ alert(d.error||'Fehler beim Anlegen'); return;} e.target.reset(); loadUsers(); }
async function onListClick(e){ const btn=e.target.closest('button[data-id]'); if(!btn) return; const id=parseInt(btn.dataset.id,10); if(!confirm('Benutzer wirklich löschen?')) return; const r=await fetch('/api/users/'+id,{method:'DELETE',headers:authHeader()}); const d=await r.json().catch(()=>({})); if(!r.ok){ alert(d.error||'Fehler beim Löschen'); return;} loadUsers(); }
function init(){ document.getElementById('logout').addEventListener('click',(e)=>{ e.preventDefault(); localStorage.removeItem('jwt'); localStorage.removeItem('user'); location.replace('/login.html'); }); requireAdmin(); document.getElementById('user-form').addEventListener('submit', addUser); document.getElementById('users-body').addEventListener('click', onListClick); loadUsers(); }
document.addEventListener('DOMContentLoaded', init);